Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-02-03T02:00:34+02:00

====== Сделать “User home directory” ======

Нужно сделать на сервере отдельный каталог для хранения пользовательских данных при логине по ssh. Такой каталог можно условно назвать “''user_settings''”.

Он нужен для сохранения настроек юзер-профилей и чтобы можно было логиниться на сервер по ssh и запускать от имени юзера тот же Midnight Commander — программам нужно записывать свои конфиги в какие-то каталоги.

Три раза внимательно с диском с каталогом “user_settings”. Если он исчезнет из OMV (поломался, вынули по ошибке или заменили), при логине по ssh потеряется возможность запускать ПО от имени залогиненного юзера, пойдут ошибки “Could not chdir to home directory”. Придётся 

	1. создать нового пользователя, аналогичного основному
	2. залогиниться под новым
	3. удалить основного
	4. заново создать «основного»…

«Обновлённый» пользователь может называться теми же буквами, но у него будет другой id, и владельцем всех ранее созданных каталогов на дисках будет оставаться пользователь со старым id. Если упустить этот момент и не переназначить права на владение каталогами для юзера «со старым названием и новым id», позже могут возникнуть непонятные сложности с записью в каталоги, и подсказки не будет.

Было бы здраво сделать каталог для настроек пользователей прямо на /dev/sda, бо это диск, который «случайно» не вынуть. Но в OMV shares на основном диске системы невозможны. Однако есть хитрый способ:
* файлы профилей юзеров будут находиться на /dev/sda1 в /home/user_settings/
* shared folder для профилей юзеров будет находиться на (например) /dev/sdd1, на котором будет сделан симлинк на в /home/user_settings/

Эта схема безопаснее — даже если диск /dev/sdd1 умрет или будет заменен, каталог с профилями пользователей останется на месте, на новом диске будет достаточно снова сделать симлинк.

===== Сделать каталог для профилей =====

На всякий случай убедиться в том, что на nas сейчас больше никто не залогинен по ssh.

Зайти на NAS по ssh под юзером ''nimda'' (''admin'' наоборот). 

''su''

''mkdir /home/user_settings/''

'''
chown astenix:sudo -R /home/user_settings/
'''

===== Сделать симлинк на каталог с профилями =====

Перейти на HDD, на котором будет создана share для каталога с файлами пользовательских профилей. Например — /dev/sdd1

''ln -s /home/user_settings/''

===== Сделать shared folder в OMV для всех пользователей =====

В браузере в OMV залогиниться под юзером ''nimda''.

Storage 
''> Shared Folders''

Создать новый Shared Folder на /dev/sdd1

* Name: user_settings
* File system: /dev/sdd1
* Relative path > Browse directory > выбрать каталог user_settings/ (на самом деле он симлинк)
* [Save]

Создать новый shared-каталог “all_user_settings” на каком-нибудь из доступных hdd:
* Permissions = Administrator: read/write, Users: read/write, Others: no access
* [Save / Apply / Yes]

Зайти в Privileges для этого каталога и поставить галочками права Read/Write для юзеров и групп.

Зайти в ACL (Access Control List — список управления доступом) для этого каталога и поставить галочками Read/Write для юзеров:
* Group = users > Read/Write/Execute
* Others = none
* Recursive = Apply

===== Назначить его как «User home directory» =====

Users 
''> Settings'' 
''> User home directory''
''> Enabled'' 
''> Location = выбрать появившийся Shared Folder «user_settings»''
''[Save]''

==== Изменить настройки основного пользователя ====

под которым будем заходить на NAS

Users 
''> Users''
''> тыкнуть по существующему юзеру (например «astenix»)''
''> [Shared folder permissions]'' 
''> в списке доступных каталогов должен появиться «user_settings»'' 
''> тыкнуть по нему и по кнопке [Read/Write]'' 
''> [Save]''

новые настройки должны подхватиться.

В крайнем случае придётся создать нового «постоянного» пользователя.

//Next step//: [[Добавить пользователей]]

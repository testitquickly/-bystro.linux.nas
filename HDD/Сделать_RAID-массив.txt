Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-01-31T16:50:30+02:00

====== Как сделать RAID-массив ======

Поскольку я строю NAS без RAID, этот сценарий рассмотрен очень
базово, как низковероятностный.
Воткнуть в сервер необходимый минимум — два новых диска. Это дей-
ствительно должны быть новые, «чистые» диски, на которых нет даже
файловой системы.
При этом логично использовать диски одного семейства с идентич-
ным размером хранилища, чтобы избежать нюансов со свободным
местом и жизненным циклом дисков.
Всегда можно «обнулить» существующий диск в Storage >
Disks > выбрать нужный > Wipe. Но делать это надо будучи
очень готовым к тому, что сейчас бобманёт не там и не туда,
а бэкапов, как всегда, нет.
Для безопасности, в мастере создания нового RAID-массива отоб-
ражаются только те диски, которые ещё нигде не задействованы
(mount) и на которых НЕТ файловой системы. Все остальные в ма-
стере RAID не отображаются, и это очень умно.
Также в OpenMediaVault диски без файловой системы не отобража-ются в Storage > File Systems.
Storage > File Systems > [+ Create]
* Device = выбрать первый из дисков, которые будут отображаться в
выпадающем списке (позже повторить всё для второго диска). Если
там пусто — goto в самое начало, бо райд можно организовать только
на дисках, на которых ещё нет файловой системы.
* Label = короткое имя диска
* File system = EXT4
Убедиться в том, что созданный диск отображается в общем списке, и
в колонке «Mounted» = No, в колонке «Used» = No, в колонке «Status» =
Online.
Storage > RAID Management > [+ Create]
* Name = произвольное
* Level = надо заранее знать, что тут выбрать
* Devices = выбрать диски для нового массива из предлагаемого спис-
ка. Если в списке дисков пусто — goto в самое начало, бо райд можно
организовать только на дисках, на которых ещё нет файловой систе-
мы.

Как восстановить RAID-массив
Хе-хе, это было неизбежно…
Не надо сразу создавать новый массив из старых дисков. Это может
сработать, а может и нет. Вообще, при потере информации на RAID
надо прекратить любую запись на диски и заняться выуживанием
данных. И ребилдить только ПОСЛЕ бэкапов.
Лечение зависит от того, что засбоило — диск или RAID-
контроллер (или сперва что-то одно, а затем другое), а также
от типа RAID-массива, поэтому в них надо разбираться самостоя-
тельно. А также от собственной беспечности в отношении бэкапов.
И от решения держать диски зашифрованными или нет.
Если просто умер один из дисков, но данные всё ещё есть, просто
падает скорость записи/чтения данных, то общий алгоритм немед-
ленных действий таков:
1. сделать бэкап того, что есть (для этого нужны другие дис-
ки достаточной ёмкости, которые постоянно должны быть в запасе…),
2. пока идёт бэкап, СПОКОЙНО попытаться определить ис-
точник неполадок: контроллер или диски, бо от этого зави-
сят следующие шаги,
3. заменить умирающий hdd (держать новый про запас, и не
один…),
4. сделать ребилд массива.
Если сразу броситься делать ребилд, то высок риск напороться на
ранее незаметный бэд-блок на любом из дисков, и контроллер не
сможет вычитать информацию из сектора. После долгих часов ожи-
дания останется только ресетнуть компьютер и помянуть потерян-
ные данные. Sad, but true.
Отказ может произойти из-за того, что нескольких дисков
одновременно переходят переход в режим off-line, массив не
стартует и данные не отдает. Вероятно, на дисках уже нако-
пились бэд-блоки. Или контроллер руководствуется диагно-
стикой S.M.A.R.T. и определяет диск как «мертвый».
Бывает, что после смерти одного из дисков контроллер
неверно обрабатывает ситуацию и массив либо перестает
корректно работать, либо становится недоступным чуть бо-
лее, чем полностью. Это может произойти даже во время пе-
рестроения/восстановления массива. Иногда падение дис-
ков происходит почти последовательно. Никто не обещал,
что будет легко.
Контроллеры бывают программные (простейшее и худшее
решение, где всё делает процессор сервера), или встроенные
в материнскую плату, или в виде отдельных плат (можно за-
менять) или даже внешних устройств с собственным процес-
сором (дорого-богато, чуть надёжнее и проще в обслужива-
нии). В зависимости от его типа надо принимать те или иные
решения.
Если данные очень важны — лучше не экспериментировать и от-
нести диски в специализированные конторы, работники которых
с интересом посмотрят всё их содержимое. Ну да, ну да, мы же не
для того поднимали NAS в домашних условиях…




//Next step//: [[index]]


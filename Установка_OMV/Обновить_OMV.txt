Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-01-31T14:45:24+02:00

====== Обновить OMV ======

Если есть возможность сделать бэкап NAS — сделать.

Убедиться в том, что на диске для системы есть свободное место.

Пересмотреть все установленные плагины (кроме unionfs / mergefolderfs, они будут автоматически обновлены). Если они не готовы к следующей версии OMV — или удалить их, или заменить docker-контейнером, если есть такая возможность.

	1. предположим, что обновляемся с OMV 6 на OMV 7
	2. залогиниться через браузер на свой NAS > System > Plugins. Там будет общий список доступных плагинов, отдельные из них можно у себя установить. 
	3. отсортировать список плагинов по колонке «Installed». Смотреть каждый плагин с пометкой «Installed» последовательно, и убедиться в том, что он есть в каталоге ’omv7_plugins’ через https://wiki.omv-extras.org/doku.php?id=omv7:omv7 

Если действующий в OMV 6 плагин есть в списке плагинов для OMV 7, то всё норм, 

Если его нет, то или отключить его (удалить, собственно, если это возможно) из своего NAS, или отложить обновление системы — это же  Debian, даже после завершения поддержки дистрибутив ещё будет работать год-два.

	Плагин openmediavault-nut (связь с UPS) можно оставить.

Если есть софт из внешних репозиториев — убедиться в том, что он готов к обновлению, иначе лучше его удалить.

Выполнить на NAS проверку того, что действующий OMV и все его настройки в норме и готов к обновлению.

''sudo omv-salt stage run deploy''

Дождаться ответа. Пример ответа:

''Summary for debian''
''Succeeded: 2 (changed=2)''
''Failed:    0''

===== Обновление OMV =====

1

''sudo omv-upgrade''

Если есть ошибки — остановиться и гуглить решения.

	Пример ошибки — [[https://www.cyberciti.biz/faq/the-repository-http-deb-debian-org-debian-buster-backports-release-no-longer-has-a-release-file/|The repository 'http://deb.debian.org/debian buster-backports Release' no longer has a Release file]].

	Если всё починено, то повторить ''sudo omv-upgrade''

2

''sudo omv-release-upgrade''

Если есть ошибки — остановиться и гуглить решения. Единственное предупреждение, которое нас не напрягает, это «error message from patch which says a patch has alredy been applied», это можно игнорироватью

Дождаться отработки всех скриптов. 

Reboot.

3

В браузере сделать принудительный refresh (Crtl+F5)

Протыкать последовательно все включенные сервисы и docker containers. Если что-то не будет работать, или если будут сообщения про Linux image Updates, которое невозможно установить/обновить через GUI — вернуться в консоль и снова выполнить ''omv-upgrade''.

В будущем разумно обновляться только из веб-интерфейса.

	Но если это дебиан, то не будет логичным сделать '''apt-get update && apt-get upgrade && apt dist-upgrade'''?

	Нет.

	„OMV” работает на устаревшем стабледебе, и это правильно. dist-upgrade принесёт обновления из других репозиториев, и OMV почти однозначно разломается, решением будет только переустановка с нуля.

Тут же в консоли можно поставить дебиановский софт вроде MidnightCommander.

===== Если нужный «суровый апгрейд» =====

Редко, но может понадобиться хардкорный апгрейд на стороне сервера. Например, когда сделал какую-то глупость или когда разработчики OMV сообщают о том, что можно/нужно обновить сам Debian.

На сервере:
1. залогиниться как root
2. [ОПЦИОНАЛЬНО, но полезно] ''omv-firstaid > выбрать “clean-apt”''
3. ''omv-upgrade''

Получить все обновления.

На ноуте:
1. в браузере залогиниться в OMV
2. пройти в System > Update Management > Updates
3. убедиться в том, что ничего не предлагается к обновлению

На сервере:
1. reboot
2. убедиться в том, что после перезагрузки всё в норме

//Next step//: [[Базовая настройка сервера]]
